---
title: "PVA of the NBI: Fecundity analysis" ## name of your project
author: "Your Name"                     ## your name(s)
date: "`r Sys.Date()`"                  ## current date
output:
  rmdformats::readthedown:
    code_folding: hide                  ## hide or show code by default?
    toc_depth: 3                        ## 3-level TOC
---

```{r setup, include=FALSE}
## You can ignore this chunk in most cases
## If you want to modify chunk options, you can do it here for all chunks or
## add the options in the repsective chunk header, e.g. `{r, message = FALSE}`
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = TRUE,
                      fig.width = 9, fig.height = 6, dpi = 500, 
                      retina = 1, fig.showtext = TRUE)
```

* **Research question:** (Q1) How will the NBI population develop in the next 50 years and what will be the extinction risk, given that the colonies will be either managed or left to themselves? (Q2) Will the developments in the two already established colonies Burghausen & Kuchl be different? 
* **Study area:** Austria, Germany and Italy
* **Data:** Life History data and Breeding data of the NBI

In this script we calculated the fecundity for the population. The fecundity is calculated is the number of fledged female chicks per year divided by the number of potential mothers per year. As potential mothers we used only females in stage 4, the adults. 
We calculated the fecundity in 3 ways: "Baseline", "Status quo" and "All chicks".
For the "Baseline" Fecundity we used only female fledged chicks which are born in the population from mothers who lived/lives in the population. We did not include chicks from temporarily added females and we did not include these temporarily added females as mothers. So we did not include some chicks which are part of the population.
For the "Status quo" Fecundity we included also the parent raised chicks from the temporarily added females.
In the third way "All chicks" we included the chicks which were raised by the human foster parents.


# Setup

```{r packages}
## for non-CRAN packages please keep install instruction
## but commented so it is not run each time, e.g.
# devtools::install_github("EcoDynIZW/template")

## libraries used in this script
## please add ALL LIBRARIES NEEDED HERE
## please remove libraries from the list that are not needed anymore 
## at a later stage
library("here")
library("viridisLite")
```


# Data

```{r data}
NBI <- readRDS(file = here::here("output", "data-proc", "NBI_data.rds"))

NBI_breeding_all <- readRDS(file = here::here("output", "data-proc", "NBI_breeding.rds"))
```

# Preparation
## Potential mothers
### Overall
Investigate females in stage 4 that could breed.
```{r}
NBI_mothers <- subset(x = NBI, subset = NBI$sex == "f" & NBI$yof >3)
rownames(NBI_mothers) <- NULL
```

```{r}
# Subset rows from NBI_breeding where the females were part
NBI_breeding <- subset(NBI_breeding_all, NBI_breeding_all$b_parent_f %in% NBI_mothers$name)

# Add a column for the year of the breeding event
NBI_breeding$breed_year <- substring(NBI_breeding$b_pair_date, 1, 4)
```

```{r}
# Create test tables
#test <- NBI_mothers[1:5,]
#test_breed <- NBI_breeding[1:5,]

# Create 12 columns for the years 2008-2019
NBI_mothers[,26:37] <- as.numeric(NA)
colnames(x = NBI_mothers)[26:37] <- c("2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019")
```

```{r}
# 
nrow(NBI_mothers)
nrow(NBI_breeding)

# Compare values per row of NBI_mothers
for (i in 1:nrow(NBI_mothers)) {
  
  # compare values per row of NBI_breedinging
  for (j in 1:nrow(NBI_breeding)) {
    
    # if the name in row i of NBI_mothers is the same as the name in row j of NBI_breeding is the same ...
    if (NBI_mothers$name[i] == NBI_breeding$b_parent_f[j]) {
      # NBI_mothers function: print the name of the individual
      #print(NBI_mothers$name[i])
      # ... then compare the values per columns of NBI_mothers
       for (k in 1:ncol(NBI_mothers)) {
        # if the year in row j of NBI_breeding has the same number as the column k of NBI_mothers
        if (NBI_breeding$breed_year[j] == colnames(NBI_mothers)[k]) {
          # NBI_mothers function: print the number of fledglings ... 
          #print(NBI_breeding[j,9])
          # ... then write the number of fledglings (row j and column 9 of NBI_breeding) in row i and column k of NBI_mothers
          NBI_mothers[i,k] <- NBI_breeding[j,9]

      }


      }
    
  }
  
    
  }
  
}

# There are 31 potential mothers between 2008 and 2019
```

```{r}
#test <- NBI_mothers[,c(2,3,4,12, 26:37)]
# add 0's in the table for years where a female could have breed
# I will do it by hand, I hope I can change that later
#1 "Gonzo"     2011 0
#2 "Bima"      2012 0
#3 "Pepe"      
#4 "Goja"      
#5 "Alberich"  2013 0
#6 "Salem"     
#7 "Iris"      2014-2016 0
#8 "Senta"     2014,2015 0
#9 "Luna"      2017 0
#10 "Vitorio"   
#11 "Peter"     
#12 "Flumisel"  2018 0
#13 "Luigi"     2017-2019 0
#14 "Pernille"  2017 0
#15 "Leopold"   2017-2019 0
#16 "Leonardo"  
#17 "Marvin"    
#18 "Gemini"    2018 0
#19 "Hannibal"  2018-2019 0
#20 "Camillo"   
#21 "Pinocchio" 2018 0
#22 "Dante"     2018 0
#23 "Fynn"      2018-2019 0
#24 "Frieda"    2018 0
#25 "Bianca"    2018-2019 0
#26 "Fiona"     2019 0
#27 "Altea"     2019 0
#28 "Cassandra" 2019 0
#29 "Poncho"    2019 0
#30 "Dali"      2019 0
#31 "Charlie"   2019 0

# 2011 = col 29, 2012 = 30, 2013 = 31, 2014 = 32, 2015 = 33, 2016 = 34, 2017 = 35, 2018 = 36, 2019 = 37

# Change values for 2011
NBI_mothers[1,29] <- 0


# Change values for 2012
NBI_mothers[2,30] <- 0

# Change values for 2013
NBI_mothers[5,31] <- 0

# Change values for 2014
NBI_mothers[c(7,8),32] <- 0

# Change values for 2015
NBI_mothers[c(7,8),33] <- 0

# Change values for 2016
NBI_mothers[7,34] <- 0

# Change values for 2017
NBI_mothers[c(9,13,14,15),35] <- 0

# Change values for 2018
NBI_mothers[c(12,13,15,18,19,21,22,23,24,25),36] <- 0

# Change values for 2019
NBI_mothers[c(13,15,19,23,25,26,27,28,29,30,31),37] <- 0

```


### Per year
Count the number of potential mothers per year from the table
```{r}
pot_mothers <- c(length(NBI_mothers$"2008"[!is.na(NBI_mothers$"2008")]),
                 length(NBI_mothers$"2009"[!is.na(NBI_mothers$"2009")]),
                 length(NBI_mothers$"2010"[!is.na(NBI_mothers$"2010")]),
                 length(NBI_mothers$"2011"[!is.na(NBI_mothers$"2011")]),
                 length(NBI_mothers$"2012"[!is.na(NBI_mothers$"2012")]),
                 length(NBI_mothers$"2013"[!is.na(NBI_mothers$"2013")]),
                 length(NBI_mothers$"2014"[!is.na(NBI_mothers$"2014")]),
                 length(NBI_mothers$"2015"[!is.na(NBI_mothers$"2015")]),
                 length(NBI_mothers$"2016"[!is.na(NBI_mothers$"2016")]),
                 length(NBI_mothers$"2017"[!is.na(NBI_mothers$"2017")]),
                 length(NBI_mothers$"2018"[!is.na(NBI_mothers$"2018")]),
                 length(NBI_mothers$"2019"[!is.na(NBI_mothers$"2019")]))

pot_mothers
```


## (BP) Chicks per year
```{r}
# List all mother IDs
NBI_mothers$bird_id

# List all chicks from the respective mother IDs
NBI_chicks_allcol <- NBI[NBI$parent_f_id == 6 | NBI$parent_f_id == 8| 
                         NBI$parent_f_id == 9| NBI$parent_f_id == 99098| 
                         NBI$parent_f_id == 99113| NBI$parent_f_id == 17| 
                         NBI$parent_f_id == 18| NBI$parent_f_id == 19| 
                        NBI$parent_f_id == 32| NBI$parent_f_id == 35| 
                        NBI$parent_f_id == 47| NBI$parent_f_id == 49| 
                        NBI$parent_f_id == 53| NBI$parent_f_id == 57| 
                        NBI$parent_f_id == 60| NBI$parent_f_id == 79| 
                        NBI$parent_f_id == 87| NBI$parent_f_id == 88| 
                        NBI$parent_f_id == 90| NBI$parent_f_id == 93| 
                        NBI$parent_f_id == 94| NBI$parent_f_id == 99| 
                        NBI$parent_f_id == 112| NBI$parent_f_id == 114| 
                        NBI$parent_f_id == 117| NBI$parent_f_id == 120| 
                        NBI$parent_f_id == 130| NBI$parent_f_id == 133| 
                        NBI$parent_f_id == 136| NBI$parent_f_id == 144| 
                        NBI$parent_f_id == 149, ]

rownames(NBI_chicks_allcol) <- NULL
NBI_chicks_allcol <- droplevels(NBI_chicks_allcol)
```
```{r}
# all of them should have the raising type BP
table(NBI_chicks_allcol$raising_type) # fine

# table the colony
table(NBI_chicks_allcol$breeding_area)
```
```{r}
# Create a table only with the female chicks
NBI_chicks_f <- subset(NBI_chicks_allcol, subset = NBI_chicks_allcol$sex == "f")
NBI_chicks_f <- droplevels(NBI_chicks_f)
table(NBI_chicks_f$sex) # 35 of 71 chicks are females
table(NBI_chicks_f$hatch_year)
```

```{r}
# calculate the number of female fledglings per year
chicks <- c(length(NBI_chicks_f$bird_id[NBI_chicks_f$hatch_year == "2008"]), 
            length(NBI_chicks_f$bird_id[NBI_chicks_f$hatch_year == "2009"]),
            length(NBI_chicks_f$bird_id[NBI_chicks_f$hatch_year == "2010"]),
            length(NBI_chicks_f$bird_id[NBI_chicks_f$hatch_year == "2011"]),
            length(NBI_chicks_f$bird_id[NBI_chicks_f$hatch_year == "2012"]),
            length(NBI_chicks_f$bird_id[NBI_chicks_f$hatch_year == "2013"]),
            length(NBI_chicks_f$bird_id[NBI_chicks_f$hatch_year == "2014"]),
            length(NBI_chicks_f$bird_id[NBI_chicks_f$hatch_year == "2015"]),
            length(NBI_chicks_f$bird_id[NBI_chicks_f$hatch_year == "2016"]),
            length(NBI_chicks_f$bird_id[NBI_chicks_f$hatch_year == "2017"]),
            length(NBI_chicks_f$bird_id[NBI_chicks_f$hatch_year == "2018"]),
            length(NBI_chicks_f$bird_id[NBI_chicks_f$hatch_year == "2019"]))
chicks
```
```{r}
# Insert one half of chicks of unknown sex
# Because their sex is unknown, we inserted one half of unknown chicks. So there can be for example a half chick.

U_chicks_tab<- subset(NBI, NBI$sex == "u")

u_chicks <- c(length(U_chicks_tab$bird_id[U_chicks_tab$hatch_year == "2008"]), 
              length(U_chicks_tab$bird_id[U_chicks_tab$hatch_year == "2009"]),
              length(U_chicks_tab$bird_id[U_chicks_tab$hatch_year == "2010"]),
              length(U_chicks_tab$bird_id[U_chicks_tab$hatch_year == "2011"]),
              length(U_chicks_tab$bird_id[U_chicks_tab$hatch_year == "2012"]),
              length(U_chicks_tab$bird_id[U_chicks_tab$hatch_year == "2013"]),
              length(U_chicks_tab$bird_id[U_chicks_tab$hatch_year == "2014"]),
              length(U_chicks_tab$bird_id[U_chicks_tab$hatch_year == "2015"]),
              length(U_chicks_tab$bird_id[U_chicks_tab$hatch_year == "2016"]),
              length(U_chicks_tab$bird_id[U_chicks_tab$hatch_year == "2017"]),
              length(U_chicks_tab$bird_id[U_chicks_tab$hatch_year == "2018"]),
              length(U_chicks_tab$bird_id[U_chicks_tab$hatch_year == "2019"]))

u_f_chicks <- u_chicks/2
u_chicks
u_f_chicks
```

# Baseline Fecundity
```{r}
# Create a table for the potential mothers and chicks per year
Baseline_Fecundity_table <- data.frame(Category = c("Potential mothers", "F Chicks", "Fecundity"), 2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019)
Baseline_Fecundity_table[1,2:13] <- pot_mothers
Baseline_Fecundity_table[2,2:13] <- chicks + u_f_chicks
Baseline_Fecundity_table[3,2:13] <- Baseline_Fecundity_table[2,2:13]/Baseline_Fecundity_table[1,2:13]

# 2008 to 2011 are not necessary. 2008 to 2010 have no potential mothers and 2011 only 1 potential mother and no chicks.
Baseline_Fecundity_table[,2:5] <- NULL
```

## Calculate the Mean Fecundity
```{r}
Fecundity_Baseline <- rowMeans(Baseline_Fecundity_table[3,2:9])
Fecundity_Baseline <- round(Fecundity_Baseline, digits = 2)
Fecundity_Baseline_SD <- round(sd(Baseline_Fecundity_table[3,2:9]), digits = 2)

Fecundity_Baseline
Fecundity_Baseline_SD
```
Improve the value by 10%, 25% and 100%
```{r}
Fecundity_10 <- round(Fecundity_Baseline + (Fecundity_Baseline / 10), digits = 2)
Fecundity_25 <- round(Fecundity_Baseline + (Fecundity_Baseline / 4), digits = 2)
Fecundity_100 <- round(Fecundity_Baseline * 2, digits = 2)

Fecundity_Baseline
Fecundity_10
Fecundity_25
Fecundity_100 # 1.06 means 1.06 female chicks per female per year
```
## Plot
Set up a matrix with 2 values per row: Potential mothers and female chicks per year. 
The NA is for a white space between the values per year.
This is basically for the plot
```{r}
Baseline_fec_mat <- matrix(data = c( 
  Baseline_Fecundity_table$X2012[1], Baseline_Fecundity_table$X2012[2], NA,
  Baseline_Fecundity_table$X2013[1], Baseline_Fecundity_table$X2013[2], NA,
  Baseline_Fecundity_table$X2014[1], Baseline_Fecundity_table$X2014[2], NA,
  Baseline_Fecundity_table$X2015[1], Baseline_Fecundity_table$X2015[2], NA,
  Baseline_Fecundity_table$X2016[1], Baseline_Fecundity_table$X2016[2], NA,
  Baseline_Fecundity_table$X2017[1], Baseline_Fecundity_table$X2017[2], NA,
  Baseline_Fecundity_table$X2018[1], Baseline_Fecundity_table$X2018[2], NA,
  Baseline_Fecundity_table$X2019[1], Baseline_Fecundity_table$X2019[2]))

Baseline_fec_mat
```

Build a vector for the fecundity per year 
```{r}
Baseline_fec_year <- Baseline_Fecundity_table[3,2:9]
Baseline_fec_year
```
Build a vector for the place in the plot where the fecundity should be plotted
```{r}
time_fec <- c(2,5,8,11,14,17, 20, 23)
```

Plot the potential mothers and chicks per year
Then add the lines for fecundity per year and mean fecundity to this plot.
```{r}
par(mar = c(5,4.5,2,5))

barplot(Baseline_fec_mat, beside = T, border = NA, 
        ylim = c(0,25), ylab = "Number of Individuals", xlab = "Years", cex.axis = 1.8, cex.lab = 2, 
        col = c("#DE4968FF","#51127CFF", "white" ), 
        legend = c("Potential Mothers", "Chicks", "Fecundity", "Mean Fecundity"), 
        args.legend = list(x = "topleft", 
                           fill = c("#DE4968FF","#51127CFF",magma(1, begin = 0.8),viridis(1,begin = 0.7)), 
                           ncol = 2, cex = 1.5, border = NA, bty = "n"))

axis(side = 1, at = c(2,5,8,11,14,17, 20, 23), labels = c(2012:2019), cex.axis = 1.8)

par(new = T)
plot(time_fec, Baseline_fec_year, type = "l", xaxt = "n", yaxt = "n", xlab = "", ylab = "", ylim = c(0,1), 
     lwd = 4, col = magma(1, begin = 0.8), xlim = c(1,24))
axis(side = 4, cex.axis = 1.8)
mtext(text = "Fecundity", side = 4, line = 3, cex = 2)
abline(h = Fecundity_Baseline, lwd = 4, col = viridis(1,begin = 0.7), lty = 1)

box()

```

Save the Plot
```{r}
# png(filename = here("plots", "03_fecundity", "fecundity_baseline.png"), width = 900, height = 600)
# par(mar = c(5,4.5,2,5))
# 
# barplot(Baseline_fec_mat, beside = T, border = NA, 
#         ylim = c(0,25), ylab = "Number of Individuals", xlab = "Years", cex.axis = 1.8, cex.lab = 2, 
#         col = c("#DE4968FF","#51127CFF", "white" ), 
#         legend = c("Potential Mothers", "Chicks", "Fecundity", "Mean Fecundity"), 
#         args.legend = list(x = "topleft", 
#                            fill = c("#DE4968FF","#51127CFF",magma(1, begin = 0.8),viridis(1,begin = 0.7)), 
#                            ncol = 2, cex = 1.5, border = NA, bty = "n"))
# 
# axis(side = 1, at = c(2,5,8,11,14,17, 20, 23), labels = c(2012:2019), cex.axis = 1.8)
# 
# par(new = T)
# plot(time_fec, Baseline_fec_year, type = "l", xaxt = "n", yaxt = "n", xlab = "", ylab = "", ylim = c(0,1), 
#      lwd = 4, col = magma(1, begin = 0.8), xlim = c(1,24))
# axis(side = 4, cex.axis = 1.8)
# mtext(text = "Fecundity", side = 4, line = 3, cex = 2)
# abline(h = Fecundity_Baseline, lwd = 4, col = viridis(1,begin = 0.7), lty = 1)
# 
# box()
# 
# dev.off()
```


# Status quo fecundity
All female BP raised chicks including chicks from temporally added individuals
```{r}
NBI_BP_chicks <- c(
  length(NBI$bird_id[NBI$raising_type == "parent" & NBI$sex == "f" & NBI$hatch_year == "2008"]),
  length(NBI$bird_id[NBI$raising_type == "parent" & NBI$sex == "f" & NBI$hatch_year == "2009"]),
  length(NBI$bird_id[NBI$raising_type == "parent" & NBI$sex == "f" & NBI$hatch_year == "2010"]),
  length(NBI$bird_id[NBI$raising_type == "parent" & NBI$sex == "f" & NBI$hatch_year == "2011"]),
  length(NBI$bird_id[NBI$raising_type == "parent" & NBI$sex == "f" & NBI$hatch_year == "2012"]),
  length(NBI$bird_id[NBI$raising_type == "parent" & NBI$sex == "f" & NBI$hatch_year == "2013"]),
  length(NBI$bird_id[NBI$raising_type == "parent" & NBI$sex == "f" & NBI$hatch_year == "2014"]),
  length(NBI$bird_id[NBI$raising_type == "parent" & NBI$sex == "f" & NBI$hatch_year == "2015"]),
  length(NBI$bird_id[NBI$raising_type == "parent" & NBI$sex == "f" & NBI$hatch_year == "2016"]),
  length(NBI$bird_id[NBI$raising_type == "parent" & NBI$sex == "f" & NBI$hatch_year == "2017"]),
  length(NBI$bird_id[NBI$raising_type == "parent" & NBI$sex == "f" & NBI$hatch_year == "2018"]),
  length(NBI$bird_id[NBI$raising_type == "parent" & NBI$sex == "f" & NBI$hatch_year == "2019"]))
NBI_BP_chicks
```

Create a table for the potential mothers and chicks per year
```{r}
Statquo_Fecundity_table <- data.frame(Category = c("Potential mothers", "Chicks", "Fecundity"), 2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019)
Statquo_Fecundity_table[1,2:13] <- pot_mothers
Statquo_Fecundity_table[2,2:13] <- NBI_BP_chicks + u_f_chicks
Statquo_Fecundity_table[3,2:13] <- Statquo_Fecundity_table[2,2:13]/Statquo_Fecundity_table[1,2:13]

# 2008 to 2011 are not necessary. 2008 to 2010 have no potential mothers and 2011 only 1 potential mother and no chicks.
Statquo_Fecundity_table[,2:5] <- NULL
Statquo_Fecundity_table
```


## Calculate the Mean Fecundity
```{r}
Fecundity_Statquo <- rowMeans(Statquo_Fecundity_table[3,2:9])
Fecundity_Statquo <- round(Fecundity_Statquo, digits = 2)
Fecundity_Statquo
```

## Plot
Set up a matrix with 2 values per row: Potential mothers and chicks per year. The NA is for a white space between the values per year.
```{r}
Statquo_fec_mat <- matrix(data = c( 
  Statquo_Fecundity_table$X2012[1], Statquo_Fecundity_table$X2012[2], NA,
  Statquo_Fecundity_table$X2013[1], Statquo_Fecundity_table$X2013[2], NA,
  Statquo_Fecundity_table$X2014[1], Statquo_Fecundity_table$X2014[2], NA,
  Statquo_Fecundity_table$X2015[1], Statquo_Fecundity_table$X2015[2], NA,
  Statquo_Fecundity_table$X2016[1], Statquo_Fecundity_table$X2016[2], NA,
  Statquo_Fecundity_table$X2017[1], Statquo_Fecundity_table$X2017[2], NA,
  Statquo_Fecundity_table$X2018[1], Statquo_Fecundity_table$X2018[2], NA,
  Statquo_Fecundity_table$X2019[1], Statquo_Fecundity_table$X2019[2]))
```

```{r}
Statquo_fec_year <- Statquo_Fecundity_table[3,2:9]
Statquo_fec_year
```

Plot the potential mothers and chicks per year
Then add the lines for fecundity per year and mean fecundity to this plot.
```{r}
par(mar = c(5,4.5,2,5))
barplot(Statquo_fec_mat, beside = T, border = NA, ylim = c(0,25), ylab = "Number of Individuals", xlab = "Years",
        cex.axis = 1.8, cex.lab = 2, col = c("#DE4968FF","#51127CFF", "white" ), 
        legend = c("Potential Mothers", "Chicks", "Fecundity", "Mean Fecundity"), 
        args.legend = list(x = "topleft", fill = c("#DE4968FF","#51127CFF",magma(1, begin = 0.8),viridis(1,begin = 0.7)), 
                           ncol = 2, cex = 1.5, border = NA, bty = "n"))
axis(side = 1, at = c(2,5,8,11,14,17,20,23), labels = c(2012:2019), cex.axis = 1.8)

par(new = T)
plot(time_fec, Statquo_fec_year, type = "l", xaxt = "n", yaxt = "n", xlab = "", ylab = "", ylim = c(0,3.5), 
     lwd = 4, col = magma(1, begin = 0.8), xlim = c(1,24))
axis(side = 4, cex.axis = 1.8)
mtext(text = "Fecundity", side = 4, line = 3, cex = 2)
abline(h = Fecundity_Statquo, lwd = 4, col = viridis(1,begin = 0.7), lty = 1)
box()
par(mar = c(5, 4, 4, 2) + 0.1)
```

Save the Plot
```{r}
# png(filename = here("plots", "03_fecundity", "fecundity_statquo.png"), width = 900, height = 600)
# par(mar = c(5,4.5,2,5))
# 
# barplot(Statquo_fec_mat, beside = T, border = NA, ylim = c(0,25), ylab = "Number of Individuals", xlab = "Years",
#         cex.axis = 1.8, cex.lab = 2, col = c("#DE4968FF","#51127CFF", "white" ), 
#         legend = c("Potential Mothers", "Chicks", "Fecundity", "Mean Fecundity"), 
#         args.legend = list(x = "topleft", fill = c("#DE4968FF","#51127CFF",magma(1, begin = 0.8),viridis(1,begin = 0.7)), 
#                            ncol = 2, cex = 1.5, border = NA, bty = "n"))
# axis(side = 1, at = c(2,5,8,11,14,17,20,23), labels = c(2012:2019), cex.axis = 1.8)
# 
# par(new = T)
# plot(time_fec, Statquo_fec_year, type = "l", xaxt = "n", yaxt = "n", xlab = "", ylab = "", ylim = c(0,3.5), 
#      lwd = 4, col = magma(1, begin = 0.8), xlim = c(1,24))
# axis(side = 4, cex.axis = 1.8)
# mtext(text = "Fecundity", side = 4, line = 3, cex = 2)
# abline(h = Fecundity_Statquo, lwd = 4, col = viridis(1,begin = 0.7), lty = 1)
# box()
# par(mar = c(5, 4, 4, 2) + 0.1)
# 
# dev.off()
```

# All chicks fecundity
BP chicks per mother (Baseline Fecundity) and FP chicks per year

Count the female FP chicks per year
This is needed for the "All chicks" Scenario
```{r}
FP_chicks_tab <- subset(NBI, NBI$raising_type == "foster parent" & NBI$sex == "f")
FP_chicks <- c(
  length(FP_chicks_tab$bird_id[FP_chicks_tab$hatch_year == "2008"]),
  length(FP_chicks_tab$bird_id[FP_chicks_tab$hatch_year == "2009"]),
  length(FP_chicks_tab$bird_id[FP_chicks_tab$hatch_year == "2010"]),
  length(FP_chicks_tab$bird_id[FP_chicks_tab$hatch_year == "2011"]),
  length(FP_chicks_tab$bird_id[FP_chicks_tab$hatch_year == "2012"]),
  length(FP_chicks_tab$bird_id[FP_chicks_tab$hatch_year == "2013"]),
  length(FP_chicks_tab$bird_id[FP_chicks_tab$hatch_year == "2014"]),
  length(FP_chicks_tab$bird_id[FP_chicks_tab$hatch_year == "2015"]),
  length(FP_chicks_tab$bird_id[FP_chicks_tab$hatch_year == "2016"]),
  length(FP_chicks_tab$bird_id[FP_chicks_tab$hatch_year == "2017"]),
  length(FP_chicks_tab$bird_id[FP_chicks_tab$hatch_year == "2018"]),
  length(FP_chicks_tab$bird_id[FP_chicks_tab$hatch_year == "2019"]))
FP_chicks
```
Create a table for the potential mothers and chicks per year
```{r}
Allchicks_Fecundity_table <- data.frame(Category = c("Potential mothers", "P_Chicks", "FP_Chicks", "All_Chicks", "Fecundity"), 2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019)
Allchicks_Fecundity_table[1,2:13] <- pot_mothers
Allchicks_Fecundity_table[2,2:13] <- chicks + u_f_chicks
Allchicks_Fecundity_table[3,2:13] <- FP_chicks
Allchicks_Fecundity_table[4,2:13] <- Allchicks_Fecundity_table[2,2:13] + Allchicks_Fecundity_table[3,2:13]
Allchicks_Fecundity_table[5,2:13] <- Allchicks_Fecundity_table[4,2:13]/Allchicks_Fecundity_table[1,2:13]

# 2008 to 2013 are not necessary. 2008 to 2010 have no potential mothers and 2011 only 1 potential mother and no chicks. And 2012-2013 have no FP chicks.
Allchicks_Fecundity_table[,2:7] <- NULL
Allchicks_Fecundity_table
```

## Calculate the Mean Fecundity
```{r}
Fecundity_Allchicks <- rowMeans(Allchicks_Fecundity_table[5,2:7])
Fecundity_Allchicks
```

## Plot
Set up a matrix with 2 values per row: Potential mothers and chicks per year. The NA is for a white space between the values per year.
```{r}
Allchicks_fec_mat <- matrix(data = c( 
  Allchicks_Fecundity_table$X2014[1], Allchicks_Fecundity_table$X2014[4], NA,
  Allchicks_Fecundity_table$X2015[1], Allchicks_Fecundity_table$X2015[4], NA,
  Allchicks_Fecundity_table$X2016[1], Allchicks_Fecundity_table$X2016[4], NA,
  Allchicks_Fecundity_table$X2017[1], Allchicks_Fecundity_table$X2017[4], NA,
  Allchicks_Fecundity_table$X2018[1], Allchicks_Fecundity_table$X2018[4], NA,
  Allchicks_Fecundity_table$X2019[1], Allchicks_Fecundity_table$X2019[4]))
```

All chicks-fecundity per year
```{r}
Allchicks_fec_year <- Allchicks_Fecundity_table[5,2:7]
Allchicks_fec_year
```
Build a vector for the place in the plot where the fecundity should be plotted
```{r}
Allchicks_time_fec <- c(2,5,8,11,14,17)
```

Plot the potential mothers and chicks per year
Then add the lines for fecundity per year and mean fecundity to this plot.
```{r}
par(mar = c(5,4.5,2,5))
barplot(Allchicks_fec_mat, beside = T, border = NA, ylim = c(0,35), ylab = "Number of Individuals", xlab = "Years",
        cex.axis = 1.8, cex.lab = 2, col = c("#DE4968FF","#51127CFF", "white" ), 
        legend = c("Potential Mothers", "Chicks", "Fecundity", "Mean Fecundity"), 
        args.legend = list(x = "topleft", fill = c("#DE4968FF","#51127CFF",magma(1, begin = 0.8),viridis(1,begin = 0.7)), 
                           ncol = 2, cex = 1.5, border = NA, bty = "n"))
axis(side = 1, at = c(2,5,8,11,14,17), labels = c(2014:2019), cex.axis = 1.8)

par(new = T)
plot(Allchicks_time_fec, Allchicks_fec_year, type = "l", xaxt = "n", yaxt = "n", xlab = "", ylab = "", ylim = c(0,6.2), 
     lwd = 4, col = magma(1, begin = 0.8), xlim = c(1,18))
axis(side = 4, cex.axis = 1.8)
mtext(text = "Fecundity", side = 4, line = 3, cex = 2)
abline(h = Fecundity_Allchicks, lwd = 4, col = viridis(1,begin = 0.7), lty = 1)
box()
par(mar = c(5, 4, 4, 2) + 0.1)
```

Save the Plot
```{r}
png(filename = here("plots", "03_fecundity", "fecundity_allchicks.png"), width = 900, height = 600)
par(mar = c(5,4.5,2,5))

barplot(Allchicks_fec_mat, beside = T, border = NA, ylim = c(0,35), ylab = "Number of Individuals", xlab = "Years",
        cex.axis = 1.8, cex.lab = 2, col = c("#DE4968FF","#51127CFF", "white" ), 
        legend = c("Potential Mothers", "Chicks", "Fecundity", "Mean Fecundity"), 
        args.legend = list(x = "topleft", fill = c("#DE4968FF","#51127CFF",magma(1, begin = 0.8),viridis(1,begin = 0.7)), 
                           ncol = 2, cex = 1.5, border = NA, bty = "n"))
axis(side = 1, at = c(2,5,8,11,14,17), labels = c(2014:2019), cex.axis = 1.8)

par(new = T)
plot(Allchicks_time_fec, Allchicks_fec_year, type = "l", xaxt = "n", yaxt = "n", xlab = "", ylab = "", ylim = c(0,6.2), 
     lwd = 4, col = magma(1, begin = 0.8), xlim = c(1,18))
axis(side = 4, cex.axis = 1.8)
mtext(text = "Fecundity", side = 4, line = 3, cex = 2)
abline(h = Fecundity_Allchicks, lwd = 4, col = viridis(1,begin = 0.7), lty = 1)
box()
par(mar = c(5, 4, 4, 2) + 0.1)

dev.off()
```

# Fecundity per colony
Split the NBI_mothers table
```{r}
B_NBI_mothers <- subset(NBI_mothers, NBI_mothers$breeding_colony == "B")
K_NBI_mothers <- subset(NBI_mothers, NBI_mothers$breeding_colony == "K")
```

## Potential mothers per year
Count the number of potential mothers per year from the table.
```{r}
B_pot_mothers <- c(length(B_NBI_mothers$hatching_08[!is.na(B_NBI_mothers$hatching_08)]),
                 length(B_NBI_mothers$hatching_09[!is.na(B_NBI_mothers$hatching_09)]),
                 length(B_NBI_mothers$hatching_10[!is.na(B_NBI_mothers$hatching_10)]),
                 length(B_NBI_mothers$hatching_11[!is.na(B_NBI_mothers$hatching_11)]), 
                 length(B_NBI_mothers$hatching_12[!is.na(B_NBI_mothers$hatching_12)]), 
                 length(B_NBI_mothers$hatching_13[!is.na(B_NBI_mothers$hatching_13)]), 
                 length(B_NBI_mothers$hatching_14[!is.na(B_NBI_mothers$hatching_14)]), 
                 length(B_NBI_mothers$hatching_15[!is.na(B_NBI_mothers$hatching_15)]), 
                 length(B_NBI_mothers$hatching_16[!is.na(B_NBI_mothers$hatching_16)]), 
                 length(B_NBI_mothers$hatching_17[!is.na(B_NBI_mothers$hatching_17)]))

K_pot_mothers <- c(length(K_NBI_mothers$hatching_08[!is.na(K_NBI_mothers$hatching_08)]),
                 length(K_NBI_mothers$hatching_09[!is.na(K_NBI_mothers$hatching_09)]),
                 length(K_NBI_mothers$hatching_10[!is.na(K_NBI_mothers$hatching_10)]),
                 length(K_NBI_mothers$hatching_11[!is.na(K_NBI_mothers$hatching_11)]), 
                 length(K_NBI_mothers$hatching_12[!is.na(K_NBI_mothers$hatching_12)]), 
                 length(K_NBI_mothers$hatching_13[!is.na(K_NBI_mothers$hatching_13)]), 
                 length(K_NBI_mothers$hatching_14[!is.na(K_NBI_mothers$hatching_14)]), 
                 length(K_NBI_mothers$hatching_15[!is.na(K_NBI_mothers$hatching_15)]), 
                 length(K_NBI_mothers$hatching_16[!is.na(K_NBI_mothers$hatching_16)]), 
                 length(K_NBI_mothers$hatching_17[!is.na(K_NBI_mothers$hatching_17)]))

```



# Fecundity per raising type



# Questions: 
Bei jahren in denen weibliche NBI keien Jungtiere kriegen: WIe kann man den Prozess zum Eintragen der NUllen automatisieren? Ich habe die Zahlen jetzt per Hand eingetragen

***

<details><summary>Session Info</summary>

```{r sessionInfo}
## DO NOT REMOVE!
## We store the settings of your computer and the current versions of the
## packages used to allow for reproducibility
Sys.time()
#git2r::repository() ## uncomment if you are using GitHub
sessionInfo()
```

</details>

