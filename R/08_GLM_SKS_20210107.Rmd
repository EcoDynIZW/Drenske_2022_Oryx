---
title: "PVA of the NBI: GLM of survival and reproduction probabilities" ## name of your project
author: "Sinah Drenske, changed by SKS"                     ## your name(s)
date: "`r Sys.Date()`"                  ## current date
output:
  rmdformats::readthedown:
    code_folding: hide                  ## hide or show code by default?
    toc_depth: 3                        ## 3-level TOC
---

```{r setup, include=FALSE}
## You can ignore this chunk in most cases
## If you want to modify chunk options, you can do it here for all chunks or
## add the options in the repsective chunk header, e.g. `{r, message = FALSE}`
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = TRUE,
                      fig.width = 9, fig.height = 6, dpi = 500, 
                      retina = 1, fig.showtext = TRUE)
```

* **Research question:** (Q1) How will the NBI population develop in the next 50 years and what will be the extinction risk, given that the colonies will be either managed or left to themselves? (Q2) Will the developments in the two already established colonies Burghausen & Kuchl be different? 
* **Study area:** Austria, Germany and Italy
* **Data:** Data of the mean per scenario for the two NetLogo models


# Setup
```{r packages}
## for non-CRAN packages please keep install instruction
## but commented so it is not run each time, e.g.
# devtools::install_github("EcoDynIZW/template")

## libraries used in this script
## please add ALL LIBRARIES NEEDED HERE
## please remove libraries from the list that are not needed anymore 
## at a later stage
library("DHARMa")
library("effects")
library("fields")
library("gam")
library("ggeffects")
library("ggplot2")
library("here")
library("lme4")
library("margins")
library("mgcv")
library("plot3D")
library("pwr")
```


# Data
```{r data}
df_sc_mean <- readRDS(file = here("output", "data-proc", "NetLogo-proc", "df_sc_mean.rds"))
#df_sc_StevS_mean <- readRDS(file = here("output", "data-proc", "NetLogo-proc", "df_sc_StevS_mean.rds"))
chicks_year <- readRDS(file = here("output", "data-proc", "chicks_year.rds"))
NBI_breeding_all <- readRDS(file = here("output", "data-proc", "NBI_breeding_all.rds"))
```

# Management improvement scenarios
```{r}
unique(df_sc_mean$Repro)
```

Change the column names
```{r}
colnames(df_sc_mean)[20:24] <- c("m1", "m2", "m3", "m4", "RR") 
```

Add columns for survival
```{r}
df_sc_mean$s1 <- (1 - df_sc_mean$m1)
df_sc_mean$s2 <- (1 - df_sc_mean$m2)
df_sc_mean$s3 <- (1 - df_sc_mean$m3)
df_sc_mean$s4 <- (1 - df_sc_mean$m4)
```


```{r}
print("m1 vs s1")
table(df_sc_mean$m1)
table(df_sc_mean$s1)
print("m2 vs s2")
table(df_sc_mean$m2)
table(df_sc_mean$s2)
print("m3 vs s3")
table(df_sc_mean$m3)
table(df_sc_mean$s3)
print("m4 vs s4")
table(df_sc_mean$m4)
table(df_sc_mean$s4)
```

## Calculate extinction probability
```{r}
df_sc_mean$pext <- df_sc_mean$Extinct/100
```

## SKS Explore database
```{r}
names(df_sc_mean)
View(df_sc_mean) # okay, these are mortalities.

unique(df_sc_mean[,c(20:24)])
unique(df_sc_mean$s1)
unique(df_sc_mean$s2)
unique(df_sc_mean$s3)
unique(df_sc_mean$s4)
unique(df_sc_mean$RR)

# start with pExt
table(df_sc_mean$pext)#df_sc_StevS_mean
#  0    0.01 0.02 0.03 0.06 0.24 
# 316    4    3    1    1    1 



# comment: with such a distribution of the response variable, there is no need to calculate a model. Better describe these:

tmp <- which(df_sc_mean$pext > 0)
tmp2 <- df_sc_mean[tmp,]
View(tmp2)
table(tmp2$s1)
table(tmp2$s2)
table(tmp2$s3)
table(tmp2$s4)
table(tmp2$RR)
# -> coloured xls

########################

# lambda
#install.packages("plot3D")
x <- df_sc_mean$s1
y <- df_sc_mean$RR
z <- df_sc_mean$Lambda_sto
scatter3D(x, y, z, pch = 19, cex = 0.5, clab = c("Lambda"))

require(lattice)
contourplot(Lambda_sto ~ s1 * RR, data = df_sc_mean, labels = FALSE,
            region = TRUE)


plot(df_sc_mean$Lambda_sto)
abline(h=1)

```

```{r}
table(df_sc_mean$s1)
table(df_sc_mean$s2)
table(df_sc_mean$s3)
table(df_sc_mean$s4)
table(df_sc_mean$RR)
```



## GAM
A general additive model (GAM) tests for non-linearity

The extinction probability is the response variable and the predictor variables are formed by the survival probabilities per stage (s1-s4) and the reproduction (RR)
```{r}
# define a k
# myk - stands for 'my number of knots/ smoothing splines' :-)
myk <- 3 # or 4
```

Build the model
```{r}
gammod_1 <- gam(formula = pext ~ s(s1, k=myk) + s(s2, k=myk) + 
                          s(s3, k=myk) + s(s4, k=myk) + 
                          s(RR, k=myk), 
                data = df_sc_mean, na.action = 'na.fail', family=binomial)
```

## SKS trial gammod for lambda
```{r}
gammod_1 <- gam(formula = Lambda_sto ~ s(s1, k=myk) + s(s2, k=myk) + 
                          s(s3, k=myk) + s(s4, k=myk) +  
                          s(RR, k=myk), 
                          data = df_sc_mean, 
                          na.action = 'na.fail', family=Gamma) 
summary(gammod_1) 
# an der F statistics sieht man, dass s4 und RR den größten Einfluss haben
# das sollte dann auch im GLm so rauskommen

gammod_1_2 <- gam(formula = Lambda_sto ~ s(m1, k=myk) + s(m2, k=myk) + 
                          s(m3, k=myk) + s(m4, k=myk) +  
                          s(RR, k=myk), 
                          data = df_sc_mean, 
                          na.action = 'na.fail', family=Gamma) 
summary(gammod_1_2) 
# an der F statistics sieht man, dass s4 und RR den größten Einfluss haben
# das sollte dann auch im GLm so rauskommen


# no difference between survival and mortality
```


```{r}
plot(gammod_1)
# vis.gam(gammod_1, view = c("s4", "RR"), plot.type = "persp", type = "response", zlim = c(0,1.6), 
#         ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
#         xlab = "s4", ylab = "RR", zlab = "Lambda", 
#         color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)

vis.gam(gammod_1, view = c("s4", "RR"), plot.type = "persp", type = "response", zlim = c(0.5,1.6), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "s4", ylab = "RR", zlab = "Lambda", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)

vis.gam(gammod_1_2, view = c("m4", "RR"), plot.type = "persp", type = "response", zlim = c(0.5,1.6), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "m4", ylab = "RR", zlab = "Lambda", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)
```


```{r}
vis.gam(gammod_1, view = c("s1", "s2"), plot.type = "persp", type = "response", zlim = c(0.5,1.6), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "s1", ylab = "s2", zlab = "Lambda", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)
```


```{r}
# s4 and RR
png(filename = here("plots", "04_PVA", "persp_s4_RR_lambda_202102.png"), width = 1200, height = 772)
vis.gam(gammod_1, view = c("s4", "RR"), plot.type = "persp", type = "response", zlim = c(0.5,1.6), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "s4", ylab = "RR", zlab = "Lambda", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)
dev.off()
```


Analyse the model
```{r}
summary(gammod_1)
```

Calculating the effect size
```{r}
pwr.t.test(n=326, sig.level=0.05, power = 0.8, alternative="greater")
```


### Plots
#### Effects plots
```{r}
plot(gammod_1)
```

#### Perspective plot
```{r}
vis.gam(gammod_1, view = c("s4", "RR"), plot.type = "persp", type = "response", zlim = c(0,1), 
        ticktype = "simple", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "Mortality of adult NBI", ylab = "Reproductive rate", zlab = "Extinction probability", 
        color = "heat", theta= -140)
#image.plot(zlim=c(0,1), legend.only=TRUE, col = heat.colors(1000))


vis.gam(gammod_1, view = c("s4", "s1"), plot.type = "persp", type = "response", zlim = c(0,1), 
        ticktype = "simple", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "Mortality of adult NBI", ylab = "Mortality of juvenile NBI", zlab = "Extinction probability", 
        color = "heat", theta= -140)

vis.gam(gammod_1, view = c("s1", "RR"), plot.type = "persp", type = "response", zlim = c(0,1), 
        ticktype = "simple", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "Mortality of juvenile NBI", ylab = "Reproductive rate", zlab = "Extinction probability", 
        color = "heat", theta= -140)

vis.gam(gammod_1, view = c("s2", "s3"), plot.type = "persp", type = "response", zlim = c(0,1), 
        ticktype = "simple", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "Mortality of 1 year old NBI", ylab = "Mortality of 2 years old NBI", zlab = "Extinction probability", 
        color = "heat", theta= -140)
```

Legend only
```{r}
#plot( 1:10, 1:10)
image.plot(zlim=c(0,1), legend.only=TRUE, col = heat.colors(100))
```

Save plots
```{r}
# # s4 and RR
# png(filename = here("plots", "04_PVA", "persp_s4_RR.png"), width = 1200, height = 772)
# vis.gam(gammod_1, view = c("s4", "RR"), plot.type = "persp", type = "response", zlim = c(0,1), 
#         ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
#         xlab = "s4", ylab = "RR", zlab = "Extinction probability", 
#         color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)
# dev.off()
# 
# # s1 and s4
# png(filename = here("plots", "04_PVA", "persp_s1_s4.png"), width = 1200, height = 772)
# vis.gam(gammod_1, view = c("s4", "s1"), plot.type = "persp", type = "response", zlim = c(0,1), 
#         ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
#         xlab = "s4", ylab = "\ns1", zlab = "Extinction probability", 
#         color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)
# dev.off()
# 
# # s1 and RR
# png(filename = here("plots", "04_PVA", "persp_s1_RR.png"), width = 1200, height = 772)
# vis.gam(gammod_1, view = c("s1", "RR"), plot.type = "persp", type = "response", zlim = c(0,1), 
#         ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
#         xlab = "\ns1", ylab = "RR", zlab = "Extinction probability", 
#         color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)
# dev.off()
# 
# # s2 and s3
# png(filename = here("plots", "04_PVA", "persp_s2_s3.png"), width = 1200, height = 772)
# vis.gam(gammod_1, view = c("s2", "s3"), plot.type = "persp", type = "response", zlim = c(0,1), 
#         ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
#         xlab = "s2", ylab = "s3", zlab = "Extinction probability", 
#         color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)
# dev.off()
```

```{r}
# Legend
# png(filename = here("plots", "04_PVA", "persp_Legend.png"), width = 100, height = 600)
# image.plot(zlim=c(0,1), legend.only=TRUE, col = heat.colors(100), legend.cex = 1, legend.width = 1.5)
# dev.off()
```


## GLM
### Family binomial
```{r}
# Without interactions
mod1 <- glm(pext ~ s1 + s2 + s3 + s4 +
                RR, data = df_sc_mean, na.action = 'na.fail', family=binomial)

# With interactions between s4 and RR
mod1_2 <- glm(pext ~ s1 + s2 + s3 + s4 *
                RR, data = df_sc_mean, na.action = 'na.fail', family=binomial)

# With all possible interactions
mod1_3 <- glm(pext ~ s1 * s2 * s3 * s4 *
                RR, data = df_sc_mean, na.action = 'na.fail', family=binomial)



```

```{r}
summary(mod1) # same p-values as for gammod1

summary(mod1_2)

summary(mod1_3)
```


### Lambda
```{r}
# test SKS
# With all possible interactions
library('MuMIn')
# mod1_3 <- glm(Lambda_sto ~ (s1 + s2 + s3 + s4) * RR, 
#               data = df_sc_mean, na.action = 'na.fail', family=gaussian)
mod1_3_1 <- glm(Lambda_sto ~ (s1 + s2 + s3 + s4) + RR, 
              data = df_sc_mean, na.action = 'na.fail', family=Gamma)

#dredge(mod1_33)
plot(allEffects(mod1_3_1),type='response')


mod1_3_2 <- glm(Lambda_sto ~ (m1 + m2 + m3 + m4) + RR, 
              data = df_sc_mean, na.action = 'na.fail', family=Gamma)

#dredge(mod1_33)
plot(allEffects(mod1_3_2),type='response')
```


```{r}
# summary(mod1_3) # nimm  den t value für das ranking, oder 
# anova(mod1_3, test='LRT') # den deviance term. -> s4 erklärt am MEisten
# 


# mortality richtig benennne!!!!!
```

```{r}
# glm, anova for variable ranking. Anova table in den Appendix. With s4 and RR explaining most of the variance. 
```

```{r}
summary(mod1_3_1) # nimm  den t value für das ranking, oder 
anova(mod1_3_1, test='LRT') # den deviance term. -> s4 erklärt am MEisten
```

```{r}
summary(mod1_3_2) # nimm  den t value für das ranking, oder 
anova(mod1_3_2, test='LRT') # den deviance term. -> s4 erklärt am MEisten

```



```{r}
#install.packages('modelsummary') #cooles package übrigens! macht layout für Tabellen selbst!
library(modelsummary)
datasummary_skim(df_sc_mean)
varnam <- c('s1' = 'Survival of stage 1',
            's2' = 'Survival of stage 2',
            's3' = 'Survival of stage 3',
            's4' = 'Survival of stage 4',
            'RR' = 'Reproductive Rate')
varnam2 <- c('m1' = 'Mortality of stage 1',
            'm2' = 'Mortality of stage 2',
            'm3' = 'Mortality of stage 3',
            'm4' = 'Mortality of stage 4',
            'RR' = 'Reproductive Rate')
# modelplot(mod1_3, 
#           coef_omit = 'Interc',
#           coef_map = varnam, 
#           conf_level = .99) # ein bisschen hässlich, aber man sieht 
#dass s4 und RR wichtig sind, und s1 eigentlich nicht....

modelplot(mod1_3_1, 
          coef_omit = 'Interc',
          coef_map = varnam, 
          conf_level = .99) 
#  abline(v=0) wenn möglich

modelplot(mod1_3_2, 
          coef_omit = 'Interc',
          coef_map = varnam2, 
          conf_level = .99) 
```

Calculating R square 
R^2= 1-(Residual deviance/Null deviance) 
```{r}
round(1 - (0.06403/1.88066), digits = 2) # the same as the one in the GAM
```

#### Plot
For family = binomial
```{r}
gg_mod_1 <- ggeffect(mod1_3_1)
```

```{r}
#show_pals()
```

```{r}
gg_mod_x <- gg_mod_1
names(gg_mod_1)
```

```{r}
plot(x = gg_mod_1, ci = T, facets = T, add.data = F, colors = "bw",line.size = 1) + 
  theme_light() + 
  theme(panel.grid = element_blank(), 
        text = element_text(face = "bold"),  
        strip.background =element_rect(fill="grey50"), 
        strip.text.x = element_text(size = 20), 
        axis.text = element_text(size = 18), 
        axis.ticks = element_line(size = 2), 
        axis.ticks.length = unit(.25, "cm"), 
        axis.title = element_text(size = 21)) + 
  labs(x = "Probability of predictor variables", y = "Lambda")  
```

```{r}
png(filename = here("plots", "04_PVA", "lambda_effects_plot202102.png"), width = 1200, height = 772)
plot(x = gg_mod_1, ci = T, facets = T, add.data = F, colors = "bw",line.size = 1) +
  theme_light() +
  theme(panel.grid = element_blank(),
        text = element_text(face = "bold"),
        strip.background =element_rect(fill="grey50"),
        strip.text.x = element_text(size = 22),
        axis.text = element_text(size = 20),
        axis.ticks = element_line(size = 2),
        axis.ticks.length = unit(.25, "cm"),
        axis.title = element_text(size = 23)) +
  labs(x = "Probability of explanatory variables", y = "Lambda")
dev.off()
```

############## SKS: weiter bin ich nicht durch ####





### Family quasibinomial
```{r}
# Without interactions
mod1_4 <- glm(pext ~ s1 + s2 + s3 + s4 +
                RR, data = df_sc_mean, na.action = 'na.fail', family=quasibinomial)

# With interactions between s4 and RR
mod1_5 <- glm(pext ~ s1 + s2 + s3 + s4 *
                RR, data = df_sc_mean, na.action = 'na.fail', family=quasibinomial)

# With all possible interactions
mod1_6 <- glm(pext ~ s1 * s2 * s3 * s4 *
                RR, data = df_sc_mean, na.action = 'na.fail', family=quasibinomial)
```

```{r}
summary(mod1_4) # same p-values as for gammod1

summary(mod1_5)

summary(mod1_6)
```

Calculating R square 
R^2= 1-(Residual deviance/Null deviance) 
```{r}
round(1 - (0.12544/3.70015), digits = 2) # the same as the one in the GAM
```
### Plot
For family = binomial
```{r}
gg_mod_1 <- ggeffect(mod1)
```

```{r}
#show_pals()
```

```{r}
gg_mod_x <- gg_mod_1
names(gg_mod_1)
```

```{r}
plot(x = gg_mod_1, ci = T, facets = T, add.data = F, colors = "bw",line.size = 1) + 
  theme_light() + 
  theme(panel.grid = element_blank(), 
        text = element_text(face = "bold"),  
        strip.background =element_rect(fill="grey50"), 
        strip.text.x = element_text(size = 20), 
        axis.text = element_text(size = 18), 
        axis.ticks = element_line(size = 2), 
        axis.ticks.length = unit(.25, "cm"), 
        axis.title = element_text(size = 21)) + 
  labs(x = "Probability of predictor variables", y = "Extinction probability")  
```

```{r}
# png(filename = here("plots", "04_PVA", "effects_plot.png"), width = 1200, height = 772)
# plot(x = gg_mod_1, ci = T, facets = T, add.data = F, colors = "bw",line.size = 1) + 
#   theme_light() + 
#   theme(panel.grid = element_blank(), 
#         text = element_text(face = "bold"),  
#         strip.background =element_rect(fill="grey50"), 
#         strip.text.x = element_text(size = 22), 
#         axis.text = element_text(size = 20), 
#         axis.ticks = element_line(size = 2), 
#         axis.ticks.length = unit(.25, "cm"), 
#         axis.title = element_text(size = 23)) + 
#   labs(x = "Probability of explanatory variables", y = "Extinction probability")
# dev.off()
```

```{r}
table(df_sc_mean$s4, df_sc_mean$RR)
```


# Stochastic events and Supplements
## Calculate extinction probability
the extinction probability is the response variable and the predictor variables are formed by the survival probabilities per stage (s1-s4) and the reproductive rate (RR)


Change the column names
```{r}
colnames(df_sc_StevS_mean)[21:25] <- c("s1", "s2", "s3", "s4", "RR") 
```

```{r}
df_sc_StevS_mean$pext <- df_sc_StevS_mean$Extinct/100

#length(which(table(df_sc_StevS_mean$Extinct)>0)) #727 vs 49

```

Explore data
```{r}
table(df_sc_StevS_mean$s1)
table(df_sc_StevS_mean$s2)
table(df_sc_StevS_mean$s3)
table(df_sc_StevS_mean$s4)
table(df_sc_StevS_mean$RR)
```

## GAM
```{r}
# define a k
myk <- 3 # or 4
```

```{r}
gammod_2 <- gam(formula = pext ~ s(s1, k=myk) + s(s2, k=myk) + 
                          s(s3, k=myk) + s(s4, k=myk) + 
                          s(RR, k=myk) + 
                          s(Stoch_Frequency, k=myk) + s(Stoch_Severity, k=myk), 
                data = df_sc_StevS_mean, na.action = 'na.fail', family=binomial)



```

Analyse the model
```{r}
summary(gammod_2)
```

### Lambda
```{r}
##SKS
gammod_2_2 <- gam(formula = Lambda_sto ~ s(s1, k=myk) + s(s2, k=myk) + 
                          s(s3, k=myk) + s(s4, k=myk) + 
                          s(RR, k=myk) + 
                          s(Stoch_Frequency, k=myk) + s(Stoch_Severity, k=myk), 
                data = df_sc_StevS_mean, na.action = 'na.fail', family=Gamma)
```


Analyse the model
```{r}
summary(gammod_2_2)
```

```{r}
vis.gam(gammod_2_2, view = c("s1", "s2"), plot.type = "persp", type = "response", zlim = c(0.5,1.6), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "s1", ylab = "s2", zlab = "Lambda", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)

vis.gam(gammod_2_2, view = c("s2", "s3"), plot.type = "persp", type = "response", zlim = c(0.5,1.6), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "s2", ylab = "s3", zlab = "Lambda", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)

vis.gam(gammod_2_2, view = c("s2", "RR"), plot.type = "persp", type = "response", zlim = c(0.5,1.6), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "s2", ylab = "RR", zlab = "Lambda", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)

vis.gam(gammod_2_2, view = c("s2", "s4"), plot.type = "persp", type = "response", zlim = c(0.5,1.6), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "s2", ylab = "s4", zlab = "Lambda", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)

vis.gam(gammod_2_2, view = c("s4", "RR"), plot.type = "persp", type = "response", zlim = c(0.5,1.6), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "s4", ylab = "RR", zlab = "Lambda", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)

vis.gam(gammod_2_2, view = c("s4", "Stoch_Frequency"), plot.type = "persp", type = "response", zlim = c(0.5,1.6), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "s4", ylab = "Stoch. frequency", zlab = "Lambda", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)

vis.gam(gammod_2_2, view = c("s4", "Stoch_Severity"), plot.type = "persp", type = "response", zlim = c(0.5,1.6), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "s4", ylab = "Stoch. severity", zlab = "Lambda", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)

vis.gam(gammod_2_2, view = c("RR", "Stoch_Frequency"), plot.type = "persp", type = "response", zlim = c(0.5,1.6), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "RR", ylab = "Stoch. frequency", zlab = "Lambda", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)

vis.gam(gammod_2_2, view = c("RR", "Stoch_Severity"), plot.type = "persp", type = "response", zlim = c(0.5,1.6), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "RR", ylab = "Stoch. severity", zlab = "Lambda", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)

vis.gam(gammod_2_2, view = c("Stoch_Frequency", "Stoch_Severity"), plot.type = "persp", type = "response", zlim = c(0.5,1.6), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "Stoch. frequency", ylab = "Stoch. severity", zlab = "Lambda", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)


# vis.gam(gammod_1, view = c("s4", "RR"), theta = 30,
#         #plot.type = "persp",  
#         ticktype = "simple", border = NA, n.grid = 100, nticks = 3, 
#         color = "heat",
#         xlab = "mortality s4", 
#         ylab = "RR", 
#         zlab = "Lambda")
```


### Plots
```{r}
coli <- heat.colors(n = 1000)
#z.facet.center <- (z[-1, -1] + z[-1, -ncol(z)] + z[-nrow(z), -1] + z[-nrow(z), -ncol(z)])/4
#z.facet.range<-cut(z.facet.center, 100)
```

#### Vis GAM
```{r}
vis.gam(gammod_2, view = c("s4", "RR"), plot.type = "persp", type = "response", zlim = c(0,1), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "s4", ylab = "RR", zlab = "Extinction probability", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)
```

## GLM 
Build the model
```{r}
# Without interactions
mod2 <- glm(pext ~ s1 + s2 + s3 + s4 + RR + Stoch_Frequency + Stoch_Severity, 
            data = df_sc_StevS_mean, na.action = 'na.fail', family=binomial)

# Without interactions, family quasibinomial
mod2_1 <- glm(pext ~ s1 + s2 + s3 + s4 + RR + Stoch_Frequency + Stoch_Severity, 
            data = df_sc_StevS_mean, na.action = 'na.fail', family=quasibinomial)

# With interactions between s4 and RR
mod2_2 <- glm(pext ~ s1 + s2 + s3 + s4 * RR + Stoch_Frequency + Stoch_Severity, 
            data = df_sc_StevS_mean, na.action = 'na.fail', family=binomial)

# With all possible interactions
mod2_3 <- glm(pext ~ s1 * s2 * s3 * s4 * RR * Stoch_Frequency * Stoch_Severity, 
            data = df_sc_StevS_mean, na.action = 'na.fail', family=binomial)

# With interactions between stochastic event frequency and severity
mod2_4 <- glm(pext ~ s1 + s2 + s3 + s4 + RR + Stoch_Frequency * Stoch_Severity, 
            data = df_sc_StevS_mean, na.action = 'na.fail', family=binomial)
```

```{r}
summary(mod2)
summary(mod2_1)
summary(mod2_2)
summary(mod2_3)
summary(mod2_4)
```

Calculating R square 
R^2= 1-(Residual deviance/Null deviance) 
```{r}
round(1 - (5.0577/116.5414), digits = 2) 
```

Calculating the effect size
```{r}
pwr.t.test(n=820, sig.level=0.05, power = 0.8, alternative="greater")
```

### Lambda
```{r}
# test SKS
# With all possible interactions
library('MuMIn')
# mod1_3 <- glm(Lambda_sto ~ (s1 + s2 + s3 + s4) * RR, 
#               data = df_sc_mean, na.action = 'na.fail', family=gaussian)
mod2_331 <- glm(Lambda_sto ~ s1 + s2 + s4 + RR  + Stoch_Frequency + Stoch_Severity, 
              data = df_sc_StevS_mean, na.action = 'na.fail', family=Gamma)

# s2 = s3, da nur s1 s4 oder alle verändert wurden

#dredge(mod2_33)
plot(allEffects(mod2_331),type='response')

mod2_33 <- glm(Lambda_sto ~ s4 + RR  + s1 + s2 + Stoch_Frequency + Stoch_Severity, 
              data = df_sc_StevS_mean, na.action = 'na.fail', family=Gamma)

# s2 = s3, da nur s1 s4 oder alle verändert wurden

#dredge(mod2_33)
plot(allEffects(mod2_33),type='response')
```


```{r}
summary(mod2_3) # nimm  den t value für das ranking, oder 
anova(mod2_3, test='LRT') # den deviance term. -> s4 erklärt am MEisten
```

```{r}
summary(mod2_33) # nimm  den t value für das ranking, oder 
anova(mod2_33) 
```

```{r}
summary(mod2_33) # nimm  den t value für das ranking, oder 
anova(mod2_33) 
```

Calculating R square 
R^2= 1-(Residual deviance/Null deviance) 
```{r}
round(1 - (0.25657/12.53647), digits = 2) 
```


```{r}
#install.packages('modelsummary') #cooles package übrigens! macht layout für Tabellen selbst!
library(modelsummary)
datasummary_skim(df_sc_StevS_mean)
varnam <- c('s1' = 'Mortality of stage 1',
            's2' = 'Mortality of stage 2',
            #'s3' = 'Mortality of stage 3',
            's4' = 'Mortality of stage 4',
            'RR' = 'Reproductive Rate', 
            'Stoch_Frequency' = 'Stochastic event frequency', 
            'Stoch_Severity' = 'Stochastic event severity')
modelplot(mod2_3, 
          coef_omit = 'Interc',
          coef_map = varnam, 
          conf_level = .99) # ein bisschen hässlich, aber man sieht 
#dass s4 und RR wichtig sind, und s1 eigentlich nicht....

```

```{r}
library(modelsummary)
datasummary_skim(df_sc_StevS_mean)
varnam <- c('s1' = 'Mortality of stage 1',
            's2' = 'Mortality of stage 2',
            's3' = 'Mortality of stage 3',
            's4' = 'Mortality of stage 4',
            'RR' = 'Reproductive Rate', 
            'Stoch_Frequency' = 'Stochastic event frequency', 
            'Stoch_Severity' = 'Stochastic event severity')
modelplot(mod2_33, 
          coef_omit = 'Interc',
          coef_map = varnam, 
          conf_level = .99) # ein bissc
```

### Plot
#### Perspective plot
```{r}
persp(x = mod2, xvar = "s1", yvar = "s4", type = "response", zlim = c(0,1), 
      ticktype = "detailed", border = NA, nx = 1000, nticks = 3, 
      xlab = "s1", ylab = "s4", zlab = "Extinction probability", 
      theta= -140, cex.lab = 3, cex.axis = 2.5) # border = NA,
```



```{r}
persp(x = mod2, xvar = "s4", yvar = "RR", type = "response", zlim = c(0,1), 
      ticktype = "detailed", border = NA, nx = 1000, nticks = 3, 
      xlab = "s4", ylab = "RR", zlab = "Extinction probability", 
      theta= -140, cex.lab = 3, cex.axis = 2.5, col = coli[c(0,1)])



persp(x = mod2, xvar = "s4", yvar = "Stoch_Frequency", type = "response", zlim = c(0,1), 
      ticktype = "detailed", border = NA, nx = 1000, nticks = 3, 
      xlab = "s4", ylab = "StF", zlab = "Extinction probability", 
      theta= -140, cex.lab = 3, cex.axis = 2.5, col = coli[c(0,1)])



persp(x = mod2, xvar = "s4", yvar = "Stoch_Severity", type = "response", zlim = c(0,1), 
      ticktype = "detailed", border = NA, nx = 1000, nticks = 3, 
      xlab = "s4", ylab = "StS", zlab = "Extinction probability", 
      theta= -140, cex.lab = 3, cex.axis = 2.5, col = coli[c(0,1)])



persp(x = mod2, xvar = "RR", yvar = "Stoch_Frequency", type = "response", zlim = c(0,1), 
      ticktype = "detailed", border = NA, nx = 1000, nticks = 3, 
      xlab = "RR", ylab = "StF", zlab = "Extinction probability", 
      theta= -140, cex.lab = 3, cex.axis = 2.5, col = coli[c(0,1)])



persp(x = mod2, xvar = "RR", yvar = "Stoch_Severity", type = "response", zlim = c(0,1), 
      ticktype = "detailed", border = NA, nx = 1000, nticks = 3, 
      xlab = "RR", ylab = "StS", zlab = "Extinction probability", 
      theta= -140, cex.lab = 3, cex.axis = 2.5, col = coli[c(0,1)])


persp(x = mod2, xvar = "Stoch_Frequency", yvar = "Stoch_Severity", type = "response", zlim = c(0,1), 
      ticktype = "detailed", border = NA, nx = 1000, nticks = 3, 
      xlab = "StF", ylab = "StS", zlab = "Extinction probability", 
      theta= -140, cex.lab = 3, cex.axis = 2.5, col = coli[c(0,1)])
```


```{r}
#plot(mod2)
# cplot(mod2, "s1", type = "response", ylim = c(-1,1))
# cplot(mod2, "s2", type = "response", ylim = c(-1,1))
# cplot(mod2, "s3", type = "response", ylim = c(-1,1))
# cplot(mod2, "s4", type = "response", ylim = c(-1,1))
# cplot(mod2, "RR", type = "response", ylim = c(-6,6))
# cplot(mod2, "Stoch_Frequency", type = "response", ylim = c(-1,1))
# cplot(mod2, "Stoch_Severity", type = "response", ylim = c(-1,1))
```


```{r}
gg_mod_2_1 <- ggpredict(mod2)
gg_mod_2_2 <- ggeffect(mod2)
```

```{r}
gg_mod_x <- gg_mod_2_2
names(gg_mod_2_2)
```

```{r}
# # NOT WORKING
# 
# 
# plot(x = gg_mod_2_2, ci = T, facets = T, add.data = F, colors = "bw",line.size = 1) +
#   theme_light() +
#   theme(panel.grid = element_blank(),
#         text = element_text(face = "bold"),
#         strip.background =element_rect(fill="grey50"),
#         strip.text.x = element_text(size = 20),
#         axis.text = element_text(size = 18),
#         axis.ticks = element_line(size = 2),
#         axis.ticks.length = unit(.25, "cm"),
#         axis.title = element_text(size = 21)) +
#   labs(x = "Probability of predictor variables", y = "Extinction probability")
# 
# plot(x = gg_mod_2_2, ci = T, facets = T, add.data = F, colors = "bw",line.size = 1)
# 
# plot(x = gg_mod_2_2, ci = T, facets = T, add.data = F, colors = "bw")
```

# GLMM of the number of fledglings per potential mother
Based in the values used for RR Baseline

## Data exploration
```{r}
ggplot(data = chicks_year, mapping = aes(x = n)) + 
  geom_histogram()


ggplot(data = chicks_year, mapping = aes(x = n, y = raising_type)) + 
  geom_point()

table(chicks_year$raising_type)
```

## GLM
```{r}
null_model <- glm(formula = n ~ 1, data = chicks_year, family = "poisson")
summary(null_model)

raising_mod <- glm(formula = n ~ raising_type,
                  data = chicks_year,
                  family = "poisson")
summary(raising_mod) # non significant
```

### Plot
```{r}
#dredge(raising_mod)
plot(allEffects(raising_mod),type='response')
```
## GLMM
```{r}
raising_glmm <- glmer(formula = n ~ raising_type + (1|parent_f), 
                      data = chicks_year, 
                      family = "poisson")
summary(raising_glmm)
```
### Plot
```{r}
predi <- ggpredict(raising_glmm, terms = "raising_type")
predi
```


```{r}
plot(predi, show.title = F, limits = c(0,1)) + 
  labs(x = "Raising type",y = "Number of female fledglings per potential mother", tags = "") +
  theme_classic() + 
  theme( 
    axis.line = element_line(colour = "black"),
    axis.text = element_text(size=14),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(), 
    plot.margin = unit(c(7.5, 12.5, 5.5, 15.5), "points"),
    axis.title.x = element_text(colour="black", size = 15),
    axis.title.y = element_text(colour="black",size=15, vjust = 5))
```

### Testing the models
Testing with the DHARMa package.
We tested the model with the lowest AIC: partner_glmm1.1

Prepare it
```{r}
model_simu <- simulateResiduals(fittedModel = raising_glmm)
plot(model_simu)
```

Dispersion
```{r}
testDispersion(model_simu)
```

Zero-inflation
```{r}
testZeroInflation(model_simu)
```

Temporal Autocorrelation
```{r}
testTemporalAutocorrelation(model_simu)
```


# GLMM of baseline reproductive rates between colonies
## Data exploration
```{r}
ggplot(data = chicks_year, mapping = aes(x = n)) + 
  geom_histogram()


ggplot(data = chicks_year, mapping = aes(x = n, y = breeding_area)) + 
  geom_point()

table(chicks_year$breeding_area)
```
Remove individuals with colony "allocation"
```{r}
chicks_year <- chicks_year[chicks_year$breeding_area != "allocation", ]
chicks_year <- droplevels(chicks_year)
table(chicks_year$breeding_area) # half half
```

## GLM
```{r}
null_model <- glm(formula = n ~ 1, data = chicks_year, family = "poisson")
summary(null_model)

colony_mod <- glm(formula = n ~ breeding_area,
                  data = chicks_year,
                  family = "poisson")
summary(colony_mod) # non significant
```

### Plot
```{r}
#dredge(raising_mod)
plot(allEffects(colony_mod),type='response')
```


## GLMM
```{r}
colony_glmm <- glmer(formula = n ~ breeding_area + (1|parent_f), 
                      data = chicks_year, 
                      family = "poisson")
summary(colony_glmm)
```

### Plot
```{r}
predi <- ggpredict(colony_glmm, terms = "breeding_area")
predi
```


```{r}
plot(predi, show.title = F, limits = c(0,1.1)) + 
  labs(x = "Colony",y = "Number of female fledglings per potential mother", tags = "") +
  theme_classic() + 
  theme( 
    axis.line = element_line(colour = "black"),
    axis.text = element_text(size=14),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(), 
    plot.margin = unit(c(7.5, 12.5, 5.5, 15.5), "points"),
    axis.title.x = element_text(colour="black", size = 15),
    axis.title.y = element_text(colour="black",size=15, vjust = 5))
```

### Testing the models
Testing with the DHARMa package.
We tested the model with the lowest AIC: partner_glmm1.1

Prepare it
```{r}
model_simu <- simulateResiduals(fittedModel = colony_glmm)
plot(model_simu)
```

Dispersion
```{r}
testDispersion(model_simu)
```

Zero-inflation
```{r}
testZeroInflation(model_simu)
```

Temporal Autocorrelation
```{r}
testTemporalAutocorrelation(model_simu)
```

# GLMM of reproductive rates per nest (RRNest) between raising types
## Data exploration
```{r}
ggplot(data = NBI_breeding_all, mapping = aes(x = b_count_fleding)) + 
  geom_histogram()


ggplot(data = NBI_breeding_all, mapping = aes(x = b_count_fleding, y = raising_type)) + 
  geom_point()

table(NBI_breeding_all$raising_type)
```

## GLM
```{r}
null_model_nest <- glm(formula = b_count_fleding ~ 1, data = NBI_breeding_all, family = "poisson")
summary(null_model_nest)

raising_nest_mod <- glm(formula = b_count_fleding ~ raising_type,
                  data = NBI_breeding_all,
                  family = "poisson")
summary(raising_nest_mod) # non significant
```

### Plot
```{r}
#dredge(raising_mod)
plot(allEffects(raising_nest_mod),type='response')
```

## GLMM
```{r}
raising_nest_glmm2 <- glmer(formula = b_count_fleding ~ raising_type + b_breeding_colony + (1|b_parent_f), 
                      data = NBI_breeding_all, 
                      family = "poisson")
summary(raising_nest_glmm)
summary(raising_nest_glmm2)
```

### Plot
```{r}
predi <- ggpredict(raising_nest_glmm, terms = "raising_type")
predi
```


```{r}
plot(predi, show.title = F, limits = c(0,10)) + 
  labs(x = "Raising type",y = "Number of fledglings per nest (m + f)", tags = "") +
  theme_classic() + 
  theme( 
    axis.line = element_line(colour = "black"),
    axis.text = element_text(size=14),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(), 
    plot.margin = unit(c(7.5, 12.5, 5.5, 15.5), "points"),
    axis.title.x = element_text(colour="black", size = 15),
    axis.title.y = element_text(colour="black",size=15, vjust = 5))
```

### Testing the models
Testing with the DHARMa package.
We tested the model with the lowest AIC: partner_glmm1.1

Prepare it
```{r}
model_simu <- simulateResiduals(fittedModel = raising_nest_glmm)
plot(model_simu)
```

Dispersion
```{r}
testDispersion(model_simu)
```

Zero-inflation
```{r}
testZeroInflation(model_simu)
```

Temporal Autocorrelation
```{r}
testTemporalAutocorrelation(model_simu)
```


# GLMM of reproductive rates per nest (RRNest) between colonies
## Data exploration
```{r}
ggplot(data = NBI_breeding_all, mapping = aes(x = b_count_fleding)) + 
  geom_histogram()


ggplot(data = NBI_breeding_all, mapping = aes(x = b_count_fleding, y = b_breeding_colony)) + 
  geom_point()

table(NBI_breeding_all$b_breeding_colony)
```

## GLM


### Plot


## GLMM


### Plot


### Testing the models
Testing with the DHARMa package.
We tested the model with the lowest AIC: partner_glmm1.1

Prepare it
```{r}
model_simu <- simulateResiduals(fittedModel = raising_glmm)
plot(model_simu)
```

Dispersion
```{r}
testDispersion(model_simu)
```

Zero-inflation
```{r}
testZeroInflation(model_simu)
```

Temporal Autocorrelation
```{r}
testTemporalAutocorrelation(model_simu)
```



***

<details><summary>Session Info</summary>

```{r sessionInfo}
## DO NOT REMOVE!
## We store the settings of your computer and the current versions of the
## packages used to allow for reproducibility
Sys.time()
#git2r::repository() ## uncomment if you are using GitHub
sessionInfo()
```

</details>

