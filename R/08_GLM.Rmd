---
title: "PVA of the NBI: GLM of survival and reproduction probabilities" ## name of your project
author: "Sinah Drenske"                     ## your name(s)
date: "`r Sys.Date()`"                  ## current date
output:
  rmdformats::readthedown:
    code_folding: hide                  ## hide or show code by default?
    toc_depth: 3                        ## 3-level TOC
---

```{r setup, include=FALSE}
## You can ignore this chunk in most cases
## If you want to modify chunk options, you can do it here for all chunks or
## add the options in the repsective chunk header, e.g. `{r, message = FALSE}`
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = TRUE,
                      fig.width = 9, fig.height = 6, dpi = 500, 
                      retina = 1, fig.showtext = TRUE)
```

* **Research question:** (Q1) How will the NBI population develop in the next 50 years and what will be the extinction risk, given that the colonies will be either managed or left to themselves? (Q2) Will the developments in the two already established colonies Burghausen & Kuchl be different? 
* **Study area:** Austria, Germany and Italy
* **Data:** Data of the mean per scenario for the two NetLogo models


# Setup
```{r packages}
## for non-CRAN packages please keep install instruction
## but commented so it is not run each time, e.g.
# devtools::install_github("EcoDynIZW/template")

## libraries used in this script
## please add ALL LIBRARIES NEEDED HERE
## please remove libraries from the list that are not needed anymore 
## at a later stage
library("here")
library("ggplot2")
library("effects")
library("ggeffects")
library("gam")
library("mgcv")
library("fields")
library("pwr")
library("margins")
```


# Data
```{r data}
df_sc_mean <- readRDS(file = here("output", "data-proc", "NetLogo-proc", "df_sc_mean.rds"))
df_sc_StevS_mean <- readRDS(file = here("output", "data-proc", "NetLogo-proc", "df_sc_StevS_mean.rds"))
```

# Management improvement scenarios
```{r}
unique(df_sc_mean$Repro)
```

Change the column names
```{r}
colnames(df_sc_mean)[20:24] <- c("s1", "s2", "s3", "s4", "RR") 
```

## Calculate extinction probability
```{r}
df_sc_mean$pext <- df_sc_mean$Extinct/100
```

## GAM
A general additive model (GAM) tests for non-linearity

The extinction probability is the response variable and the predictor variables are formed by the survival probabilities per stage (s1-s4) and the reproduction (RR)
```{r}
# define a k
myk <- 3 # or 4
```

Build the model
```{r}
gammod_1 <- gam(formula = pext ~ s(s1, k=myk) + s(s2, k=myk) + 
                          s(s3, k=myk) + s(s4, k=myk) + 
                          s(RR, k=myk), 
                data = df_sc_mean, na.action = 'na.fail', family=binomial)
```

Analyse the model
```{r}
summary(gammod_1)
```

Calculating the effect size
```{r}
pwr.t.test(n=326, sig.level=0.05, power = 0.8, alternative="greater")
```


### Plots
#### Effects plots
```{r}
plot(gammod_1)
```

#### Perspective plot
```{r}
vis.gam(gammod_1, view = c("s4", "RR"), plot.type = "persp", type = "response", zlim = c(0,1), 
        ticktype = "simple", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "Mortality of adult NBI", ylab = "Reproductive rate", zlab = "Extinction probability", 
        color = "heat", theta= -140)
#image.plot(zlim=c(0,1), legend.only=TRUE, col = heat.colors(1000))


vis.gam(gammod_1, view = c("s4", "s1"), plot.type = "persp", type = "response", zlim = c(0,1), 
        ticktype = "simple", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "Mortality of adult NBI", ylab = "Mortality of juvenile NBI", zlab = "Extinction probability", 
        color = "heat", theta= -140)

vis.gam(gammod_1, view = c("s1", "RR"), plot.type = "persp", type = "response", zlim = c(0,1), 
        ticktype = "simple", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "Mortality of juvenile NBI", ylab = "Reproductive rate", zlab = "Extinction probability", 
        color = "heat", theta= -140)

vis.gam(gammod_1, view = c("s2", "s3"), plot.type = "persp", type = "response", zlim = c(0,1), 
        ticktype = "simple", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "Mortality of 1 year old NBI", ylab = "Mortality of 2 years old NBI", zlab = "Extinction probability", 
        color = "heat", theta= -140)
```

Legend only
```{r}
#plot( 1:10, 1:10)
image.plot(zlim=c(0,1), legend.only=TRUE, col = heat.colors(100))
```

Save plots
```{r}
# # s4 and RR
# png(filename = here("plots", "04_PVA", "persp_s4_RR.png"), width = 1200, height = 772)
# vis.gam(gammod_1, view = c("s4", "RR"), plot.type = "persp", type = "response", zlim = c(0,1), 
#         ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
#         xlab = "s4", ylab = "RR", zlab = "Extinction probability", 
#         color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)
# dev.off()
# 
# # s1 and s4
# png(filename = here("plots", "04_PVA", "persp_s1_s4.png"), width = 1200, height = 772)
# vis.gam(gammod_1, view = c("s4", "s1"), plot.type = "persp", type = "response", zlim = c(0,1), 
#         ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
#         xlab = "s4", ylab = "\ns1", zlab = "Extinction probability", 
#         color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)
# dev.off()
# 
# # s1 and RR
# png(filename = here("plots", "04_PVA", "persp_s1_RR.png"), width = 1200, height = 772)
# vis.gam(gammod_1, view = c("s1", "RR"), plot.type = "persp", type = "response", zlim = c(0,1), 
#         ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
#         xlab = "\ns1", ylab = "RR", zlab = "Extinction probability", 
#         color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)
# dev.off()
# 
# # s2 and s3
# png(filename = here("plots", "04_PVA", "persp_s2_s3.png"), width = 1200, height = 772)
# vis.gam(gammod_1, view = c("s2", "s3"), plot.type = "persp", type = "response", zlim = c(0,1), 
#         ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
#         xlab = "s2", ylab = "s3", zlab = "Extinction probability", 
#         color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)
# dev.off()
```

```{r}
# Legend
# png(filename = here("plots", "04_PVA", "persp_Legend.png"), width = 100, height = 600)
# image.plot(zlim=c(0,1), legend.only=TRUE, col = heat.colors(100), legend.cex = 1, legend.width = 1.5)
# dev.off()
```


## GLM
### Family binomial
```{r}
# Without interactions
mod1 <- glm(pext ~ s1 + s2 + s3 + s4 +
                RR, data = df_sc_mean, na.action = 'na.fail', family=binomial)

# With interactions between s4 and RR
mod1_2 <- glm(pext ~ s1 + s2 + s3 + s4 *
                RR, data = df_sc_mean, na.action = 'na.fail', family=binomial)

# With all possible interactions
mod1_3 <- glm(pext ~ s1 * s2 * s3 * s4 *
                RR, data = df_sc_mean, na.action = 'na.fail', family=binomial)
```

```{r}
summary(mod1) # same p-values as for gammod1

summary(mod1_2)

summary(mod1_3)
```

### Family quasibinomial
```{r}
# Without interactions
mod1_4 <- glm(pext ~ s1 + s2 + s3 + s4 +
                RR, data = df_sc_mean, na.action = 'na.fail', family=quasibinomial)

# With interactions between s4 and RR
mod1_5 <- glm(pext ~ s1 + s2 + s3 + s4 *
                RR, data = df_sc_mean, na.action = 'na.fail', family=quasibinomial)

# With all possible interactions
mod1_6 <- glm(pext ~ s1 * s2 * s3 * s4 *
                RR, data = df_sc_mean, na.action = 'na.fail', family=quasibinomial)
```

```{r}
summary(mod1_4) # same p-values as for gammod1

summary(mod1_5)

summary(mod1_6)
```

Calculating R square 
R^2= 1-(Residual deviance/Null deviance) 
```{r}
round(1 - (0.12544/3.70015), digits = 2) # the same as the one in the GAM
```
### Plot
For family = binomial
```{r}
gg_mod_1 <- ggeffect(mod1)
```

```{r}
#show_pals()
```

```{r}
gg_mod_x <- gg_mod_1
names(gg_mod_1)
```
```{r}
plot(x = gg_mod_1, ci = T, facets = T, add.data = F, colors = "bw",line.size = 1) + 
  theme_light() + 
  theme(panel.grid = element_blank(), 
        text = element_text(face = "bold"),  
        strip.background =element_rect(fill="grey50"), 
        strip.text.x = element_text(size = 20), 
        axis.text = element_text(size = 18), 
        axis.ticks = element_line(size = 2), 
        axis.ticks.length = unit(.25, "cm"), 
        axis.title = element_text(size = 21)) + 
  labs(x = "Probability of predictor variables", y = "Extinction probability")  
```

```{r}
# png(filename = here("plots", "04_PVA", "effects_plot.png"), width = 1200, height = 772)
# plot(x = gg_mod_1, ci = T, facets = T, add.data = F, colors = "bw",line.size = 1) + 
#   theme_light() + 
#   theme(panel.grid = element_blank(), 
#         text = element_text(face = "bold"),  
#         strip.background =element_rect(fill="grey50"), 
#         strip.text.x = element_text(size = 22), 
#         axis.text = element_text(size = 20), 
#         axis.ticks = element_line(size = 2), 
#         axis.ticks.length = unit(.25, "cm"), 
#         axis.title = element_text(size = 23)) + 
#   labs(x = "Probability of explanatory variables", y = "Extinction probability")
# dev.off()
```

```{r}
table(df_sc_mean$s4, df_sc_mean$RR)
```


# Stochastic events and Supplements
## Calculate extinction probability
the extinction probability is the response variable and the predictor variables are formed by the survival probabilities per stage (s1-s4) and the reproductive rate (RR)

Change the column names
```{r}
colnames(df_sc_StevS_mean)[21:25] <- c("s1", "s2", "s3", "s4", "RR") 
```

```{r}
df_sc_StevS_mean$pext <- df_sc_StevS_mean$Extinct/100
```


## GAM
```{r}
# define a k
myk <- 3 # or 4
```

```{r}
gammod_2 <- gam(formula = pext ~ s(s1, k=myk) + s(s2, k=myk) + 
                          s(s3, k=myk) + s(s4, k=myk) + 
                          s(RR, k=myk) + 
                          s(Stoch_Frequency, k=myk) + s(Stoch_Severity, k=myk), 
                data = df_sc_StevS_mean, na.action = 'na.fail', family=binomial)
```

Analyse the model
```{r}
summary(gammod_2)
```

### Plots
```{r}
coli <- heat.colors(n = 1000)
#z.facet.center <- (z[-1, -1] + z[-1, -ncol(z)] + z[-nrow(z), -1] + z[-nrow(z), -ncol(z)])/4
#z.facet.range<-cut(z.facet.center, 100)
```

#### Vis GAM
```{r}
vis.gam(gammod_2, view = c("s4", "RR"), plot.type = "persp", type = "response", zlim = c(0,1), 
        ticktype = "detailed", border = NA, n.grid = 1000, nticks = 3, 
        xlab = "s4", ylab = "RR", zlab = "Extinction probability", 
        color = "heat", theta= -140, cex.lab = 3, cex.axis = 2.5)
```

## GLM 
Build the model
```{r}
# Without interactions
mod2 <- glm(pext ~ s1 + s2 + s3 + s4 + RR + Stoch_Frequency + Stoch_Severity, 
            data = df_sc_StevS_mean, na.action = 'na.fail', family=binomial)

# Without interactions, family quasibinomial
mod2_1 <- glm(pext ~ s1 + s2 + s3 + s4 + RR + Stoch_Frequency + Stoch_Severity, 
            data = df_sc_StevS_mean, na.action = 'na.fail', family=quasibinomial)

# With interactions between s4 and RR
mod2_2 <- glm(pext ~ s1 + s2 + s3 + s4 * RR + Stoch_Frequency + Stoch_Severity, 
            data = df_sc_StevS_mean, na.action = 'na.fail', family=binomial)

# With all possible interactions
mod2_3 <- glm(pext ~ s1 * s2 * s3 * s4 * RR * Stoch_Frequency * Stoch_Severity, 
            data = df_sc_StevS_mean, na.action = 'na.fail', family=binomial)

# With interactions between stochastic event frequency and severity
mod2_4 <- glm(pext ~ s1 + s2 + s3 + s4 + RR + Stoch_Frequency * Stoch_Severity, 
            data = df_sc_StevS_mean, na.action = 'na.fail', family=binomial)
```

```{r}
summary(mod2)
summary(mod2_1)
summary(mod2_2)
summary(mod2_3)
summary(mod2_4)
```

Calculating R square 
R^2= 1-(Residual deviance/Null deviance) 
```{r}
round(1 - (5.0577/116.5414), digits = 2) 
```

Calculating the effect size
```{r}
pwr.t.test(n=820, sig.level=0.05, power = 0.8, alternative="greater")
```

### Plot
#### Perspective plot
```{r}
persp(x = mod2, xvar = "s1", yvar = "s4", type = "response", zlim = c(0,1), 
      ticktype = "detailed", border = NA, nx = 1000, nticks = 3, 
      xlab = "s1", ylab = "s4", zlab = "Extinction probability", 
      theta= -140, cex.lab = 3, cex.axis = 2.5) # border = NA,
```



```{r}
persp(x = mod2, xvar = "s4", yvar = "RR", type = "response", zlim = c(0,1), 
      ticktype = "detailed", border = NA, nx = 1000, nticks = 3, 
      xlab = "s4", ylab = "RR", zlab = "Extinction probability", 
      theta= -140, cex.lab = 3, cex.axis = 2.5, col = coli[c(0,1)])



persp(x = mod2, xvar = "s4", yvar = "Stoch_Frequency", type = "response", zlim = c(0,1), 
      ticktype = "detailed", border = NA, nx = 1000, nticks = 3, 
      xlab = "s4", ylab = "StF", zlab = "Extinction probability", 
      theta= -140, cex.lab = 3, cex.axis = 2.5, col = coli[c(0,1)])



persp(x = mod2, xvar = "s4", yvar = "Stoch_Severity", type = "response", zlim = c(0,1), 
      ticktype = "detailed", border = NA, nx = 1000, nticks = 3, 
      xlab = "s4", ylab = "StS", zlab = "Extinction probability", 
      theta= -140, cex.lab = 3, cex.axis = 2.5, col = coli[c(0,1)])



persp(x = mod2, xvar = "RR", yvar = "Stoch_Frequency", type = "response", zlim = c(0,1), 
      ticktype = "detailed", border = NA, nx = 1000, nticks = 3, 
      xlab = "RR", ylab = "StF", zlab = "Extinction probability", 
      theta= -140, cex.lab = 3, cex.axis = 2.5, col = coli[c(0,1)])



persp(x = mod2, xvar = "RR", yvar = "Stoch_Severity", type = "response", zlim = c(0,1), 
      ticktype = "detailed", border = NA, nx = 1000, nticks = 3, 
      xlab = "RR", ylab = "StS", zlab = "Extinction probability", 
      theta= -140, cex.lab = 3, cex.axis = 2.5, col = coli[c(0,1)])


persp(x = mod2, xvar = "Stoch_Frequency", yvar = "Stoch_Severity", type = "response", zlim = c(0,1), 
      ticktype = "detailed", border = NA, nx = 1000, nticks = 3, 
      xlab = "StF", ylab = "StS", zlab = "Extinction probability", 
      theta= -140, cex.lab = 3, cex.axis = 2.5, col = coli[c(0,1)])
```


```{r}
#plot(mod2)
# cplot(mod2, "s1", type = "response", ylim = c(-1,1))
# cplot(mod2, "s2", type = "response", ylim = c(-1,1))
# cplot(mod2, "s3", type = "response", ylim = c(-1,1))
# cplot(mod2, "s4", type = "response", ylim = c(-1,1))
# cplot(mod2, "RR", type = "response", ylim = c(-6,6))
# cplot(mod2, "Stoch_Frequency", type = "response", ylim = c(-1,1))
# cplot(mod2, "Stoch_Severity", type = "response", ylim = c(-1,1))
```


```{r}
gg_mod_2_1 <- ggpredict(mod2)
gg_mod_2_2 <- ggeffect(mod2)
```

```{r}
gg_mod_x <- gg_mod_2_2
names(gg_mod_2_2)
```

```{r}
# # NOT WORKING
# 
# 
# plot(x = gg_mod_2_2, ci = T, facets = T, add.data = F, colors = "bw",line.size = 1) +
#   theme_light() +
#   theme(panel.grid = element_blank(),
#         text = element_text(face = "bold"),
#         strip.background =element_rect(fill="grey50"),
#         strip.text.x = element_text(size = 20),
#         axis.text = element_text(size = 18),
#         axis.ticks = element_line(size = 2),
#         axis.ticks.length = unit(.25, "cm"),
#         axis.title = element_text(size = 21)) +
#   labs(x = "Probability of predictor variables", y = "Extinction probability")
# 
# plot(x = gg_mod_2_2, ci = T, facets = T, add.data = F, colors = "bw",line.size = 1)
# 
# plot(x = gg_mod_2_2, ci = T, facets = T, add.data = F, colors = "bw")
```


***

<details><summary>Session Info</summary>

```{r sessionInfo}
## DO NOT REMOVE!
## We store the settings of your computer and the current versions of the
## packages used to allow for reproducibility
Sys.time()
#git2r::repository() ## uncomment if you are using GitHub
sessionInfo()
```

</details>

